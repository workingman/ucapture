# Expensify Integration Server API - Learnings & Quirks

## API Endpoint
```
POST https://integrations.expensify.com/Integration-Server/ExpensifyIntegrations
```

All requests are POST with form-encoded parameters.

## Authentication
- **API calls**: Use `partnerUserID` and `partnerUserSecret` in the `credentials` object
- **Receipt image downloads**: Require browser `authToken` cookie (API creds don't work)

## Job Types

### `file` - Report Exporter
Exports report and expense data. Requires a Freemarker template.

```bash
curl -X POST 'https://integrations.expensify.com/Integration-Server/ExpensifyIntegrations' \
    -d 'requestJobDescription={
        "type":"file",
        "credentials":{"partnerUserID":"...","partnerUserSecret":"..."},
        "onReceive":{"immediateResponse":["returnRandomFileName"]},
        "inputSettings":{
            "type":"combinedReportData",
            "filters":{
                "startDate":"2020-01-01",
                "endDate":"2025-12-31"
            }
        },
        "outputSettings":{"fileExtension":"csv"}
    }' \
    --data-urlencode 'template@template.ftl'
```

**Key quirk**: The `filters` object is REQUIRED. Must have either:
- `reportIDList` - specific report IDs
- `startDate` + `endDate` (max 1 year range)
- `approvedAfter`

Without filters, you get a server error.

### `download` - File Downloader
Downloads a file previously generated by the exporter.

```bash
curl -X POST 'https://integrations.expensify.com/Integration-Server/ExpensifyIntegrations' \
    -d 'requestJobDescription={
        "type":"download",
        "credentials":{"partnerUserID":"...","partnerUserSecret":"..."},
        "fileName":"export123.csv",
        "fileSystem":"integrationServer"
    }'
```

### `reconciliation` - Card Transaction Export
For company card transactions. Requires domain admin access.
- Set `"type":"All"` or `"type":"Unreported"` in inputSettings
- Requires `domain` parameter
- Returns empty for personal accounts without company cards

## Freemarker Templates

Templates iterate over `reports` and their `transactionList`:

```freemarker
<#list reports as report>
<#list report.transactionList as expense>
${expense.merchant},${expense.amount}
</#list>
</#list>
```

### Field Naming Quirks

**"Modified" fields contain the actual data:**
- `expense.merchant` → often "(none)"
- `expense.modifiedMerchant` → actual merchant name
- `expense.amount` → often 0
- `expense.modifiedAmount` → actual amount in cents
- `expense.created` → original date
- `expense.modifiedCreated` → actual/corrected date

Use fallback pattern: `${expense.modifiedMerchant!expense.merchant!}`

**Amounts are in cents**, not dollars.

### Receipt Fields
- `expense.receiptID` - internal ID
- `expense.receiptFilename` - e.g., `w_abc123.pdf`
- `expense.receiptObject.smallThumbnail` - thumbnail URL (320px)
- `expense.receiptObject.type` - "pdf", "jpg", etc.

Note: `expense.receiptURL` is often empty even when receipt exists.

## Receipt Image Downloads

**URL Pattern:**
```
https://www.expensify.com/receipts/{filename_without_extension}.jpg
```

Example:
- Filename: `w_2ea41919f93226300999519f9c193bc22d1876f4.pdf`
- Full size JPG: `https://www.expensify.com/receipts/w_2ea41919f93226300999519f9c193bc22d1876f4.jpg`
- Thumbnail: `https://www.expensify.com/receipts/w_2ea41919f93226300999519f9c193bc22d1876f4.jpg.320.jpg`

**Authentication:**
```bash
curl -b "authToken=YOUR_TOKEN" "https://www.expensify.com/receipts/filename.jpg" -o receipt.jpg
```

Without auth cookie, you get 403.

## Report States
Valid values for `reportState` filter:
- `OPEN`
- `SUBMITTED`
- `APPROVED`
- `REIMBURSED`
- `ARCHIVED`

Combine with commas: `"reportState":"OPEN,SUBMITTED,APPROVED,REIMBURSED,ARCHIVED"`

**Important**: The `reportState` filter does NOT reliably return all reports. Reports showing as "Draft" in the UI may not appear. Use `reportIDList` with explicit IDs for reliable results.

## Report ID Formats

Two formats exist and both work in API filters:
- **New format**: `R00xxxxx` (e.g., `R009FSdHreTs`)
- **Old format**: Numeric only (e.g., `42633717`)

To get report IDs:
1. View in browser UI - IDs appear in report names as `#R00xxxxx` or `#12345678`
2. Or check URL parameters when viewing a report

## Important Limitations

1. **reportState filter is unreliable** - Use `reportIDList` with explicit IDs instead
   - Reports in "Draft" status in UI don't appear with reportState filters
   - Must specify report IDs directly to get all reports

2. **No unreported expense export** - API only exports expenses attached to reports
   - Workaround: Add unreported expenses to a temp report first

3. **No receipt download via API** - Must use browser auth cookie

4. **Date range max 1 year** - For larger ranges, make multiple requests

5. **Template required for file export** - No default output format

6. **Personal vs Corporate accounts** - Reconciliation features require domain admin

7. **Multiple workspaces** - Reports may be in different policies/workspaces
   - Use `policyIDList` to filter by workspace, or omit to get all

## Common Errors

| Error | Cause | Fix |
|-------|-------|-----|
| `No Template Submitted` | Missing template parameter | Add `--data-urlencode 'template@file.ftl'` |
| `Server error` (500) | Usually template syntax error or missing required filter | Check template syntax, add date filters |
| `File not found or missing permissions` | Trying to download receipt via API | Use browser auth cookie instead |
| `Unsupported type parameter` | Invalid job type | Use `file`, `download`, or `reconciliation` |

## Sample Export Template (JSON-friendly CSV)

```freemarker
<#if addHeader == true>
ReportID,ReportName,ReportTotal,ReportCurrency,ReportStatus,ReportCreated,TransactionID,Merchant,Amount,ConvertedAmount,Currency,Category,Created,Comment,Billable,Reimbursable,ReceiptID,ReceiptFilename,ReceiptSmall,ReceiptType
</#if>
<#list reports as report>
<#list report.transactionList as expense>
"${report.reportID!}","${report.reportName!}",${report.total!0},"${report.currency!}","${report.status!}","${report.created!}","${expense.transactionID!}","${expense.modifiedMerchant!expense.merchant!}",${expense.modifiedAmount!expense.amount!0},${expense.convertedAmount!0},"${expense.currency!}","${expense.category!}","${expense.modifiedCreated!expense.created!}","${expense.comment!}",${expense.billable?string("true","false")},${expense.reimbursable?string("true","false")},"${expense.receiptID!}","${expense.receiptFilename!}","${expense.receiptObject.smallThumbnail!}","${expense.receiptObject.type!}"
</#list>
</#list>
```

## Testing Commands

```bash
# Export reports (save as api.sh and run)
PARTNER_USER_ID="your_id"
PARTNER_USER_SECRET="your_secret"
API_URL="https://integrations.expensify.com/Integration-Server/ExpensifyIntegrations"

# Generate export
FILENAME=$(curl -s -X POST "$API_URL" \
    -d "requestJobDescription={\"type\":\"file\",\"credentials\":{\"partnerUserID\":\"$PARTNER_USER_ID\",\"partnerUserSecret\":\"$PARTNER_USER_SECRET\"},\"onReceive\":{\"immediateResponse\":[\"returnRandomFileName\"]},\"inputSettings\":{\"type\":\"combinedReportData\",\"filters\":{\"startDate\":\"2020-01-01\",\"endDate\":\"2025-12-31\"}},\"outputSettings\":{\"fileExtension\":\"csv\"}}" \
    --data-urlencode 'template@export_template.ftl')

# Download export
curl -s -X POST "$API_URL" \
    -d "requestJobDescription={\"type\":\"download\",\"credentials\":{\"partnerUserID\":\"$PARTNER_USER_ID\",\"partnerUserSecret\":\"$PARTNER_USER_SECRET\"},\"fileName\":\"$FILENAME\",\"fileSystem\":\"integrationServer\"}"

# Download receipt (requires auth cookie)
AUTH_TOKEN="your_browser_cookie"
curl -b "authToken=$AUTH_TOKEN" "https://www.expensify.com/receipts/w_abc123.jpg" -o receipt.jpg
```

# Fix F-007: Align Android Metadata Format with Worker Upload API

## Context

The Android app (uCapture) uploads audio batches to a Cloudflare Worker at:

```
POST https://audio-processor.geoff-ec6.workers.dev/v1/upload
```

The Worker validates the metadata sidecar against a strict Zod schema.
The current Android metadata format does **not** match this schema — the upload
will be rejected with HTTP 400 on every attempt.

This document tells you exactly what to change in the Android app.

---

## Upload Format (multipart/form-data)

The upload is a `multipart/form-data` POST with these fields:

| Field      | Type       | Required | Notes                                        |
|------------|------------|----------|----------------------------------------------|
| `audio`    | File       | Yes      | `.m4a` only, max 50 MB                       |
| `metadata` | File (JSON)| Yes      | See critical note below                      |
| `images`   | File(s)    | No       | `.jpg`/`.jpeg`/`.png`, max 5 MB each, max 10 |
| `priority` | String     | No       | `"immediate"` or `"normal"` (default: normal) |

> **CRITICAL — metadata must be a file part, not a string:**
> The Worker checks for `name` and `size` properties on the `metadata` field to
> confirm it is a file. If you add it with `.addFormDataPart("metadata", jsonString)`
> (plain string), the Worker returns HTTP 400: `"Missing required field: metadata"`.
> You must use `.addFormDataPart("metadata", "metadata.json", body)` with an
> explicit filename and `RequestBody`. See the Kotlin example at the bottom.

---

## Required Metadata JSON Schema

The metadata JSON file must match this structure exactly.

### Full Example

```json
{
  "recording": {
    "started_at": "2026-02-25T14:30:00.000Z",
    "ended_at":   "2026-02-25T14:45:00.000Z",
    "duration_seconds": 900.0,
    "audio_format": "aac",
    "sample_rate": 44100,
    "channels": 1,
    "bitrate": 128000,
    "file_size_bytes": 14400000
  },
  "device": {
    "model": "Pixel 7",
    "os_version": "Android 14",
    "app_version": "1.2.0"
  }
}
```

### Optional Sections

Include any of these when data is available:

```json
{
  "recording": { ... },
  "device": { ... },

  "location": {
    "latitude": 49.2827,
    "longitude": -123.1207,
    "accuracy_meters": 10.0,
    "captured_at": "2026-02-25T14:30:05.000Z",
    "address": "Vancouver, BC"
  },

  "calendar": {
    "event_id": "abc123",
    "event_title": "Team standup",
    "attendees": ["alice@example.com", "bob@example.com"]
  },

  "images": [
    {
      "filename": "photo_001.jpg",
      "captured_at": "2026-02-25T14:32:00.000Z",
      "size_bytes": 2048000
    }
  ],

  "notes": [
    {
      "text": "Action item: follow up with Alice",
      "created_at": "2026-02-25T14:40:00.000Z"
    }
  ]
}
```

---

## Field-by-Field Changes from Current Android Format

| Current Android field  | Action   | New field / location                         |
|------------------------|----------|----------------------------------------------|
| `startTime`            | Rename   | `recording.started_at` (ISO 8601 UTC string) |
| `endTime`              | Rename   | `recording.ended_at` (ISO 8601 UTC string)   |
| `durationSeconds`      | Rename   | `recording.duration_seconds` (float)         |
| `fileSizeBytes`        | Rename   | `recording.file_size_bytes` (integer)        |
| `chunkNumber`          | Remove   | Not part of the API contract                 |
| `sessionId`            | Remove   | Not used; batch_id is generated by the Worker|
| `md5Hash`              | Remove   | Not part of the API contract                 |
| *(missing)*            | Add      | `recording.audio_format` — string, e.g. `"aac"` |
| *(missing)*            | Add      | `recording.sample_rate` — integer, e.g. `44100` |
| *(missing)*            | Add      | `recording.channels` — integer, `1` for mono |
| *(missing)*            | Add      | `recording.bitrate` — integer bits/sec, e.g. `128000` |
| *(missing)*            | Add      | `device` object (see below)                  |

### device object (required, new)

```json
"device": {
  "model":       "string — e.g. Build.MODEL",
  "os_version":  "string — e.g. \"Android \" + Build.VERSION.RELEASE",
  "app_version": "string — your BuildConfig.VERSION_NAME"
}
```

---

## Timestamp Format

All date/time fields must be **ISO 8601 UTC strings**:

```
2026-02-25T14:30:00.000Z   ← correct (Z suffix = UTC)
2026-02-25T14:30:00+00:00  ← also accepted
```

In Kotlin, from a `System.currentTimeMillis()` long:

```kotlin
val instant = Instant.ofEpochMilli(timestampMs)
val isoString = DateTimeFormatter.ISO_INSTANT.format(instant)
// → "2026-02-25T14:30:00.000Z"
```

---

## Authentication

Include a Google OAuth Bearer token in every request:

```
Authorization: Bearer <google_access_token>
```

The token is validated by the Worker via Google's tokeninfo endpoint.
Use the token from the user's Google Sign-In session (`GoogleSignIn`
/ `CredentialManager`). Scopes don't matter — any valid Google access
token works.

---

## Success and Error Responses

### Success: HTTP 202

```json
{
  "batch_id": "20260225-143000-a3f2",
  "status": "uploaded",
  "message": "Batch accepted for processing"
}
```

Save the `batch_id` — use it to poll status via `GET /v1/status/{batch_id}`.

### Error: HTTP 400 (validation failure)

```json
{
  "error": "Invalid metadata",
  "details": "recording.started_at: Must be a valid ISO 8601 date string; device: Required"
}
```

The `details` field lists all Zod validation failures with dot-path field names.
This is useful for debugging schema mismatches.

### Error: HTTP 401 / 403

```
401 — no or invalid Bearer token
403 — valid token but batch belongs to different user (on status/download)
```

---

## Multipart Upload Example (Kotlin / OkHttp)

```kotlin
val metadataJson = buildMetadataJson(recording, device)  // your builder function
val metadataBytes = metadataJson.toByteArray(Charsets.UTF_8)

val requestBody = MultipartBody.Builder()
    .setType(MultipartBody.FORM)
    .addFormDataPart(
        "audio",
        audioFile.name,
        audioFile.asRequestBody("audio/mp4".toMediaType())
    )
    .addFormDataPart(
        "metadata",
        "metadata.json",
        metadataBytes.toRequestBody("application/json".toMediaType())
    )
    .addFormDataPart("priority", "normal")
    .build()

val request = Request.Builder()
    .url("https://audio-processor.geoff-ec6.workers.dev/v1/upload")
    .header("Authorization", "Bearer $googleAccessToken")
    .post(requestBody)
    .build()
```

---

## Constraints Summary

| Constraint             | Limit                    |
|------------------------|--------------------------|
| Audio format           | `.m4a` only              |
| Audio max size         | 50 MB                    |
| Image formats          | `.jpg`, `.jpeg`, `.png`  |
| Image max size         | 5 MB per image           |
| Max images per upload  | 10                       |
| Total payload max      | 100 MB                   |
| Priority values        | `"immediate"`, `"normal"`|

---

## After Uploading

Poll status to track progress:

```
GET /v1/status/{batch_id}
Authorization: Bearer <token>
```

Status values: `uploaded` → `processing` → `completed` / `failed`

When `completed`, download the transcript:

```
GET /v1/download/{batch_id}/transcript_formatted
Authorization: Bearer <token>
→ 302 redirect to a presigned R2 URL (valid 1 hour)
```

Available artifact types: `raw_audio`, `metadata`, `transcript_formatted`,
`transcript_raw`.
